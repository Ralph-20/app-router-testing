# Plan 10: API Routes & Data Sources

**Date:** 2025-11-10
**Goal:** Create Route Handlers for mock data with artificial delays + JSONPlaceholder integration

---

## Overview

Two data source strategies:
1. **JSONPlaceholder** (external API) - real network requests
2. **Route Handlers** (internal mock API) - controlled delays, custom responses

---

## Implementation Steps

### Step 1: Create Mock Data Utilities

**Location:** `my-app/app/api/_utils/mock-data.ts`

```typescript
// Mock data generators with artificial delays

export interface Post {
  id: number;
  title: string;
  body: string;
  userId: number;
}

export interface User {
  id: number;
  name: string;
  email: string;
  username: string;
}

// Simulate database delay
export async function delay(ms: number) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

// Generate mock posts
export function generateMockPosts(count: number = 10): Post[] {
  return Array.from({ length: count }, (_, i) => ({
    id: i + 1,
    title: `Mock Post ${i + 1}`,
    body: `This is the body of mock post ${i + 1}. It contains example content for cache testing.`,
    userId: Math.floor(i / 3) + 1,
  }));
}

// Generate mock users
export function generateMockUsers(count: number = 5): User[] {
  return Array.from({ length: count }, (_, i) => ({
    id: i + 1,
    name: `User ${i + 1}`,
    email: `user${i + 1}@example.com`,
    username: `user${i + 1}`,
  }));
}

// Timestamp helper
export function getTimestamp() {
  return new Date().toISOString();
}
```

### Step 2: Create Mock Posts Route Handler

**Location:** `my-app/app/api/mock/posts/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { generateMockPosts, delay, getTimestamp } from '../../_utils/mock-data';

/**
 * Mock Posts API endpoint
 * Returns posts with artificial delay to simulate database query
 * Query params:
 *   - delay: number (ms) - artificial delay (default: 500)
 *   - count: number - number of posts to return (default: 10)
 */
export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;

  // Parse query params
  const delayMs = Number(searchParams.get('delay') || 500);
  const count = Number(searchParams.get('count') || 10);

  // Log request
  console.log(`[Mock API] /api/mock/posts - delay: ${delayMs}ms, count: ${count}`);

  // Simulate database delay
  await delay(delayMs);

  // Generate mock data
  const posts = generateMockPosts(count);

  // Return with metadata
  return NextResponse.json({
    data: posts,
    meta: {
      timestamp: getTimestamp(),
      source: 'mock-api',
      delay: delayMs,
      count: posts.length,
    },
  });
}
```

### Step 3: Create Mock Users Route Handler

**Location:** `my-app/app/api/mock/users/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { generateMockUsers, delay, getTimestamp } from '../../_utils/mock-data';

/**
 * Mock Users API endpoint
 */
export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const delayMs = Number(searchParams.get('delay') || 300);
  const count = Number(searchParams.get('count') || 5);

  console.log(`[Mock API] /api/mock/users - delay: ${delayMs}ms, count: ${count}`);

  await delay(delayMs);

  const users = generateMockUsers(count);

  return NextResponse.json({
    data: users,
    meta: {
      timestamp: getTimestamp(),
      source: 'mock-api',
      delay: delayMs,
      count: users.length,
    },
  });
}
```

### Step 4: Create Dynamic ID Routes

**Location:** `my-app/app/api/mock/posts/[id]/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { generateMockPosts, delay, getTimestamp } from '../../../_utils/mock-data';

/**
 * Mock single post by ID
 * URL: /api/mock/posts/1
 */
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const searchParams = request.nextUrl.searchParams;
  const delayMs = Number(searchParams.get('delay') || 300);

  console.log(`[Mock API] /api/mock/posts/${id} - delay: ${delayMs}ms`);

  await delay(delayMs);

  const posts = generateMockPosts(100);
  const post = posts.find((p) => p.id === Number(id));

  if (!post) {
    return NextResponse.json(
      { error: 'Post not found' },
      { status: 404 }
    );
  }

  return NextResponse.json({
    data: post,
    meta: {
      timestamp: getTimestamp(),
      source: 'mock-api',
      delay: delayMs,
    },
  });
}
```

### Step 5: Create Cached Route Handler

**Location:** `my-app/app/api/cached/posts/route.ts`

```typescript
import { NextResponse } from 'next/server';
import { delay, generateMockPosts, getTimestamp } from '../../_utils/mock-data';

/**
 * Cached mock API endpoint
 * Demonstrates Route Handler caching with revalidate
 */
export async function GET() {
  console.log(`[Cached API] /api/cached/posts - fetching at ${getTimestamp()}`);

  await delay(500);

  const posts = generateMockPosts(5);

  return NextResponse.json({
    data: posts,
    meta: {
      timestamp: getTimestamp(),
      source: 'cached-mock-api',
      cached: true,
    },
  }, {
    headers: {
      'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=30',
    },
  });
}

// Cache this route for 60 seconds
export const revalidate = 60;
```

### Step 6: Create JSONPlaceholder Proxy

**Location:** `my-app/app/api/jsonplaceholder/[...path]/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';

/**
 * Proxy to JSONPlaceholder API
 * URL: /api/jsonplaceholder/posts/1 â†’ https://jsonplaceholder.typicode.com/posts/1
 * Adds timing metadata
 */
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ path: string[] }> }
) {
  const { path } = await params;
  const url = `https://jsonplaceholder.typicode.com/${path.join('/')}`;

  console.log(`[JSONPlaceholder Proxy] Fetching: ${url}`);

  const startTime = Date.now();

  try {
    const response = await fetch(url, {
      cache: 'no-store', // Always fetch fresh for demo
    });

    if (!response.ok) {
      return NextResponse.json(
        { error: 'JSONPlaceholder request failed' },
        { status: response.status }
      );
    }

    const data = await response.json();
    const duration = Date.now() - startTime;

    return NextResponse.json({
      data,
      meta: {
        timestamp: new Date().toISOString(),
        source: 'jsonplaceholder',
        duration,
        url,
      },
    });
  } catch (error) {
    console.error('[JSONPlaceholder Proxy] Error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch from JSONPlaceholder' },
      { status: 500 }
    );
  }
}
```

### Step 7: Create API Testing Page

**Location:** `my-app/app/(dashboard)/api-test/page.tsx`

```typescript
export default async function APITestPage() {
  return (
    <div className="max-w-4xl mx-auto space-y-8">
      <h2 className="text-2xl font-bold">API Routes Testing</h2>

      <section className="p-6 border rounded-lg">
        <h3 className="text-lg font-semibold mb-4">Available Endpoints</h3>
        <div className="space-y-2 text-sm font-mono">
          <APIEndpoint method="GET" path="/api/mock/posts" description="Mock posts with delay" />
          <APIEndpoint method="GET" path="/api/mock/posts?delay=1000&count=5" description="Custom delay and count" />
          <APIEndpoint method="GET" path="/api/mock/posts/1" description="Single mock post by ID" />
          <APIEndpoint method="GET" path="/api/mock/users" description="Mock users" />
          <APIEndpoint method="GET" path="/api/cached/posts" description="Cached posts (60s)" />
          <APIEndpoint method="GET" path="/api/jsonplaceholder/posts/1" description="Proxy to JSONPlaceholder" />
        </div>
      </section>

      <section className="p-4 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg text-sm">
        <p><strong>Test in browser:</strong></p>
        <p className="mt-2">Visit any endpoint URL directly, or use fetch in DevTools console:</p>
        <code className="block mt-2 p-2 bg-gray-900 text-gray-100 rounded text-xs">
          fetch('/api/mock/posts?delay=2000').then(r =&gt; r.json()).then(console.log)
        </code>
      </section>
    </div>
  );
}

function APIEndpoint({ method, path, description }: { method: string; path: string; description: string }) {
  return (
    <div className="flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-900 rounded">
      <span className="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded font-semibold">
        {method}
      </span>
      <code className="flex-1">{path}</code>
      <span className="text-gray-600 dark:text-gray-400 text-xs">{description}</span>
    </div>
  );
}
```

---

## Expected Results

- Mock API routes return data with artificial delays
- JSONPlaceholder proxy works with metadata
- All endpoints return consistent JSON format with meta info
- Delays are configurable via query params

---

## Testing

1. Visit endpoints directly in browser:
   - http://localhost:3000/api/mock/posts
   - http://localhost:3000/api/mock/posts?delay=2000
   - http://localhost:3000/api/cached/posts

2. Check Network tab - observe delays

3. Use in other demos for data fetching

---

**Status:** Ready
**Time:** 30-40 min
